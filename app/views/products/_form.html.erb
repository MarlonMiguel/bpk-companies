<% content_for :header do %>
  <%= stylesheet_link_tag 'product', media: 'all' %>
<% end %>
<div class="container my-4">
  <div class="row">
    <div class="col-md-12">
      <%= form_with(model: product, 
              url: product.persisted? ? product_path(product, locale: I18n.locale) : 
                                        products_path(locale: I18n.locale), 
              local: true) do |form| %>
        <div class="row">
          <!-- Card 1: Formulário de Produto -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5><%= product.new_record? ? "Criar Produto" : "Editar Produto" %></h5>
              </div>
              <div class="card-body">
                <!-- Upload de Imagens -->
                <div class="mb-3">
                  <%= form.label :images, "Imagens do produto", class: "form-label" %>
                  <%= form.file_field :images, multiple: true, class: "form-control", data: { action: "change->image-preview#preview" } %>
                </div>

                <!-- Contêiner de Pré-visualização das Imagens -->
                <div class="mb-3" data-minimap="true" data-image-preview-target="previewContainer">
                </div>

                <!-- Exibir imagens já salvas -->
                <% if product.persisted? && product.images.attached? %>
                  <div class="mb-3">
                    <h5>Imagens Salvas:</h5>
                    <div class="d-flex flex-wrap">
                      <% product.images.each do |image| %>
                        <div class="position-relative m-2" style="width: 80px; height: 80px;" data-controller="image" data-image-target="container">
                          <%= image_tag image, size: "80x80", class: "img-thumbnail" %>

                          <!-- Botão de exclusão usando Stimulus -->
                          <%= link_to "X", image_product_path(product, image_id: image.id, locale: I18n.locale),
                              method: :delete,
                              class: "btn btn-danger btn-sm position-absolute top-0 end-0",
                              data: { action: "image#delete", confirm: 'Tem certeza que deseja excluir esta imagem?' },
                              style: "width: 20px; height: 20px; padding: 0; border-radius: 50%; line-height: 1;" %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>

                <!-- Nome do Produto -->
                <div class="mb-3">
                  <%= form.label :name, "Nome do Produto", class: "form-label" %>
                  <%= form.text_field :name, class: "form-control" %>
                </div>
                
                <div class="mb-3">
                  <%= form.label :price, "Preço" %>
                  <%= form.number_field :price, step: 0.01, class: "form-control" %>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="mb-3">
                <%= form.label :category_id, "Categoria", class: "form-label" %>
                <select id="category-select" name="product[category_id]" class="form-select" data-controller="product" data-action="change->product#fetchAttributes">
                  <option value="">Selecione uma categoria</option>
                  <% @categories.each do |category| %>
                    <option value="<%= category.id %>" title="<%= category.full_description %>" <%= 'selected' if category.id == @product.category_id %>>
                      <%= category.description %>
                    </option>
                  <% end %>
                </select>
              </div>

              <div class="card-header">
                <h5>Atributos da Categoria</h5>
              </div>
              <div class="card-body" id="attributesContainer">
                <!-- Exibe atributos da categoria selecionada -->
                <% if @product.category && @product.category.custom_attributes.any? %>
                  <% @product.category.custom_attributes.each do |attribute| %>
                    <div class="mb-3">
                      <%= label_tag "attribute_#{attribute.id}", attribute.description %>
                      <%= text_field_tag "product[attributes_attributes][#{attribute.id}]", nil, class: "form-control" %>
                    </div>
                  <% end %>
                <% else %>
                  <p>Nenhum atributo disponível para esta categoria.</p>
                <% end %>
              </div>
            </div>
          </div>
        </div>  

        <!-- Botão de Submit -->
        <div class="mt-3 d-flex justify-content-between">
          <%= form.submit "Salvar Produto", class: "btn btn-success" %>
          <%= link_to "Voltar", products_path, class: "btn btn-secondary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
